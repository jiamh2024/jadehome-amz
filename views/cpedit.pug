doctype html
html(lang="zh-CN")
  head
    title 编辑竞品信息
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet")
    style.
      .form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 8px;
      }
      .form-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
      }
      .required-field::after {
        content: " *";
        color: #dc3545;
      }
      .dimension-inputs {
        display: flex;
        gap: 15px;
      }
      .dimension-inputs .input-group {
        flex: 1;
      }
      .image-preview {
        width: 100%;
        max-width: 200px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: none;
      }
      .current-image {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 10px;
        margin-bottom: 10px;
      }

  body
    .container.form-container
      .form-header
        h1 
          i.bi.bi-pencil-square
          span.ms-2 编辑竞品信息
        p.text-muted 请修改竞品详细信息

      form#competitorForm
        input(type="hidden" name="id" value=competitor.id)
        
        .row.mb-3
          .col-md-6
            label.form-label.required-field(for="product_name") 产品规格名称
            input#product_name.form-control(type="text" name="product_name" value=competitor.product_name required)

          .col-md-6
            label.form-label.required-field(for="brand") 品牌
            input#brand.form-control(type="text" name="brand" value=competitor.brand required)

        .row.mb-3
          .col-md-6
            label.form-label(for="asin") ASIN
            input#asin.form-control(type="text" name="asin" value=competitor.asin placeholder="亚马逊产品唯一标识")

        .row.mb-3
          .col-md-6
            label.form-label.required-field(for="country_code") 国家代码
            select#country_code.form-select(name="country_code" required)
              option(value="") -- 选择国家 --
              option(value="US" selected=(competitor.country_code === 'US')) 美国 (US)
              option(value="UK" selected=(competitor.country_code === 'UK')) 英国 (UK)
              option(value="AE" selected=(competitor.country_code === 'AE')) 阿联酋 (AE)
              option(value="SA" selected=(competitor.country_code === 'SA')) 沙特 (SA)
              option(value="CA" selected=(competitor.country_code === 'CA')) 加拿大 (CA)

          .col-md-6
            label.form-label.required-field(for="sale_price") 销售价格
            .input-group
              span.input-group-text ¥
              input#sale_price.form-control(type="number" name="sale_price" step="0.01" min="0" value=competitor.sale_price required)

        .row.mb-3
          .col-md-12
            label.form-label(for="dimensions") 产品尺寸 (cm)
            .dimension-inputs
              .input-group
                span.input-group-text 长
                input#length.form-control(type="number" name="length" step="0.01" min="0" value=competitor.length)
                span.input-group-text cm
              .input-group
                span.input-group-text 宽
                input#width.form-control(type="number" name="width" step="0.01" min="0" value=competitor.width)
                span.input-group-text cm
              .input-group
                span.input-group-text 高
                input#height.form-control(type="number" name="height" step="0.01" min="0" value=competitor.height)
                span.input-group-text cm

        .row.mb-4
          .col-md-6
            label.form-label(for="weight") 产品重量
            .input-group
              input#weight.form-control(type="number" name="weight" step="0.001" min="0" value=competitor.weight)
              span.input-group-text kg

          .col-md-6
            label.form-label(for="has_battery") 是否带电
            .form-check.mt-2
              input#has_battery.form-check-input(type="checkbox" name="has_battery" checked=competitor.has_battery)
              label.form-check-label(for="has_battery") 是

        // 添加图片上传字段
        .row.mb-3
          .col-md-12
            label.form-label 产品图片上传（最多3张）
            
            // 当前图片显示
            if competitor.image_url_1 || competitor.image_url_2 || competitor.image_url_3
              .mb-3
                p 现有图片：
                if competitor.image_url_1
                  img.current-image(src=competitor.image_url_1 alt="现有图片1")
                  input(type="hidden" name="existing_image1" value=competitor.image_url_1)
                if competitor.image_url_2
                  img.current-image(src=competitor.image_url_2 alt="现有图片2")
                  input(type="hidden" name="existing_image2" value=competitor.image_url_2)
                if competitor.image_url_3
                  img.current-image(src=competitor.image_url_3 alt="现有图片3")
                  input(type="hidden" name="existing_image3" value=competitor.image_url_3)
                p.text-muted 上传新图片将替换现有图片
            
            .mb-3
              label.form-label 图片1（主图）
              input#image1.form-control(type="file" name="image1" accept="image/*")
              img#preview1.image-preview(src="" alt="图片预览")
              small.form-text.text-muted 支持JPG、PNG格式，最大5MB
            .mb-3
              label.form-label 图片2
              input#image2.form-control(type="file" name="image2" accept="image/*")
              img#preview2.image-preview(src="" alt="图片预览")
              small.form-text.text-muted 支持JPG、PNG格式，最大5MB
            .mb-3
              label.form-label 图片3
              input#image3.form-control(type="file" name="image3" accept="image/*")
              img#preview3.image-preview(src="" alt="图片预览")
              small.form-text.text-muted 支持JPG、PNG格式，最大5MB

        .d-flex.justify-content-between
          a.btn.btn-secondary(href="/cpls")
            i.bi.bi-arrow-left
            span.ms-2 返回列表
          button.btn.btn-primary(type="submit")
            i.bi.bi-save
            span.ms-2 更新信息

      #responseToast.toast.position-fixed.top-0.end-0.m-3(style="z-index: 1100")
        .toast-header
          strong#toastTitle.me-auto 通知
          button.btn-close(type="button" data-bs-dismiss="toast")
        .toast-body#toastMessage

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
    script.
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('competitorForm');
        const toastEl = document.getElementById('responseToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toast = new bootstrap.Toast(toastEl);
        const countryCode = document.getElementById('country_code');
        
        // 单位转换函数
        function cmToIn(cm) {
          return (parseFloat(cm) / 2.54).toFixed(2);
        }
        
        function inToCm(inches) {
          return (parseFloat(inches) * 2.54).toFixed(2);
        }
        
        function kgToLb(kg) {
          return (parseFloat(kg) / 0.45359237).toFixed(2);
        }
        
        function lbToKg(lb) {
          return (parseFloat(lb) * 0.45359237).toFixed(3);
        }
        
        // 页面加载时，根据国家代码初始化单位显示
        function initUnits() {
          const isUS = countryCode.value === 'US';
          
          // 初始化尺寸单位
          if (isUS) {
            document.querySelector('label[for="dimensions"]').textContent = '产品尺寸 (in)';
            document.querySelectorAll('.dimension-inputs .input-group-text')[1].textContent = 'in'; // 长
            document.querySelectorAll('.dimension-inputs .input-group-text')[3].textContent = 'in'; // 宽
            document.querySelectorAll('.dimension-inputs .input-group-text')[5].textContent = 'in'; // 高
            
            // 如果有值，转换为英寸
            if (form.length.value) form.length.value = cmToIn(form.length.value);
            if (form.width.value) form.width.value = cmToIn(form.width.value);
            if (form.height.value) form.height.value = cmToIn(form.height.value);
          } else {
            document.querySelector('label[for="dimensions"]').textContent = '产品尺寸 (cm)';
            document.querySelectorAll('.dimension-inputs .input-group-text')[1].textContent = 'cm'; // 长
            document.querySelectorAll('.dimension-inputs .input-group-text')[3].textContent = 'cm'; // 宽
            document.querySelectorAll('.dimension-inputs .input-group-text')[5].textContent = 'cm'; // 高
          }
          
          // 初始化重量单位
          if (isUS) {
            document.querySelectorAll('.input-group-text')[7].textContent = 'lb';
            // 如果有值，转换为磅
            if (form.weight.value) form.weight.value = kgToLb(form.weight.value);
          } else {
            document.querySelectorAll('.input-group-text')[7].textContent = 'kg';
          }
        }
        
        // 初始化单位
        initUnits();
        
        // 当国家代码改变时，切换显示单位
        countryCode.addEventListener('change', function() {
          const isUS = this.value === 'US';
          const prevIsUS = (this.previousValue === 'US');
          
          // 保存当前值供下次比较
          this.previousValue = this.value;
          
          // 切换尺寸单位
          if (isUS) {
            document.querySelector('label[for="dimensions"]').textContent = '产品尺寸 (in)';
            document.querySelectorAll('.dimension-inputs .input-group-text')[3].textContent = 'in'; // 长
            document.querySelectorAll('.dimension-inputs .input-group-text')[4].textContent = 'in'; // 宽
            document.querySelectorAll('.dimension-inputs .input-group-text')[5].textContent = 'in'; // 高
            
            // 如果有值且之前不是美国单位，转换为英寸
            if (form.length.value && !prevIsUS) form.length.value = cmToIn(form.length.value);
            if (form.width.value && !prevIsUS) form.width.value = cmToIn(form.width.value);
            if (form.height.value && !prevIsUS) form.height.value = cmToIn(form.height.value);
          } else {
            document.querySelector('label[for="dimensions"]').textContent = '产品尺寸 (cm)';
            document.querySelectorAll('.dimension-inputs .input-group-text')[3].textContent = 'cm'; // 长
            document.querySelectorAll('.dimension-inputs .input-group-text')[4].textContent = 'cm'; // 宽
            document.querySelectorAll('.dimension-inputs .input-group-text')[5].textContent = 'cm'; // 高
            
            // 如果有值且之前是美国单位，转换为厘米
            if (form.length.value && prevIsUS) form.length.value = inToCm(form.length.value);
            if (form.width.value && prevIsUS) form.width.value = inToCm(form.width.value);
            if (form.height.value && prevIsUS) form.height.value = inToCm(form.height.value);
          }
          
          // 切换重量单位
          if (isUS) {
            document.querySelectorAll('.input-group-text')[6].textContent = 'lb';
            // 如果有值且之前不是美国单位，转换为磅
            if (form.weight.value && !prevIsUS) form.weight.value = kgToLb(form.weight.value);
          } else {
            document.querySelectorAll('.input-group-text')[6].textContent = 'kg';
            // 如果有值且之前是美国单位，转换为千克
            if (form.weight.value && prevIsUS) form.weight.value = lbToKg(form.weight.value);
          }
        });
        
        // 存储初始值
        countryCode.previousValue = countryCode.value;
        
        // 图片预览功能
        function setupImagePreview(inputId, previewId) {
          const input = document.getElementById(inputId);
          const preview = document.getElementById(previewId);
          
          input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
              const reader = new FileReader();
              
              reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
              }
              
              reader.readAsDataURL(this.files[0]);
            } else {
              preview.src = '';
              preview.style.display = 'none';
            }
          });
        }
        
        // 设置所有图片预览
        setupImagePreview('image1', 'preview1');
        setupImagePreview('image2', 'preview2');
        setupImagePreview('image3', 'preview3');
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // 使用FormData自动收集所有表单数据，包括文件
          const formData = new FormData(this);
          
          // 处理单位转换 - 先移除原始的单位值
          formData.delete('length');
          formData.delete('width');
          formData.delete('height');
          formData.delete('weight');
          
          // 然后根据国家代码添加转换后的值
          if (form.country_code.value === 'US') {
            if (form.length.value) formData.append('length', inToCm(form.length.value));
            if (form.width.value) formData.append('width', inToCm(form.width.value));
            if (form.height.value) formData.append('height', inToCm(form.height.value));
            if (form.weight.value) formData.append('weight', lbToKg(form.weight.value));
          } else {
            if (form.length.value) formData.append('length', form.length.value);
            if (form.width.value) formData.append('width', form.width.value);
            if (form.height.value) formData.append('height', form.height.value);
            if (form.weight.value) formData.append('weight', form.weight.value);
          }
          
          // 确保has_battery字段值正确
          formData.delete('has_battery');
          formData.append('has_battery', form.has_battery.checked ? 1 : 0);
          
          try {
            const response = await fetch('/api/cp/' + form.id.value, {
              method: 'PUT',
              body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
              showToast('success', '操作成功', '竞品信息已成功更新！');
              // 更新成功后可以重定向到详情页或列表页
              setTimeout(() => {
                window.location.href = '/cpls'; // 修改为列表页地址
              }, 1500);
            } else {
              showToast('danger', '操作失败', result.error || '更新竞品信息时出错');
            }
          } catch (error) {
            console.error('Error:', error);
            showToast('danger', '网络错误', '无法连接到服务器，请稍后再试');
          }
        });
        
        function showToast(type, title, message) {
          toastTitle.textContent = title;
          toastMessage.textContent = message;
          toastEl.className = `toast position-fixed top-0 end-0 m-3 show text-bg-${type}`;
          toast.show();
        }
      });