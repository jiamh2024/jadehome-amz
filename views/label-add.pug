extends layout

block append head
    title 添加标签模板 - JadeHome
    style.
      .form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 8px;
      }
      .required-field:after {
        content: " *";
        color: #dc3545;
      }
      .submit-loading {
        position: relative;
        pointer-events: none;
      }
      .submit-loading:after {
        content: "";
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to { transform: translateY(-50%) rotate(360deg); }
      }
      .dimension-inputs {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      .back-link {
        margin-bottom: 1rem;
        display: inline-block;
      }

block content
  .form-container
    a.back-link(href="/label/ls")
      i.bi.bi-arrow-left
      |  返回标签模板列表
    h2.mb-4 添加新标签模板
    
    // 消息提示框
    div#messageContainer(style="display: none; margin-bottom: 1rem;")

    form#labelForm(novalidate)
        div.form-group.mb-3
          label.form-label.required-field(for="length") 标签长度 (mm)
          input#length.form-control(type="number", min="1", required)
          div.invalid-feedback 请输入有效的标签长度
        
        div.form-group.mb-3
          label.form-label.required-field(for="width") 标签宽度 (mm)
          input#width.form-control(type="number", min="1", required)
          div.invalid-feedback 请输入有效的标签宽度
        
        div.form-group.mb-3
          label.form-label(for="logo_path") 商标图案路径
          input#logo_path.form-control(type="text", placeholder="输入商标图案的路径")
        
        div.form-group.mb-3
          label.form-label(for="email") 电子邮箱
          input#email.form-control(type="email", placeholder="输入联系邮箱")
        
        div.form-group.mb-3
          label.form-label(for="website") 网址
          input#website.form-control(type="url", placeholder="输入网站地址")
        
        div.form-group.mb-3
          label.form-label(for="qr_code_link") 二维码图案链接
          input#qr_code_link.form-control(type="text", placeholder="输入二维码图案的链接")
        
        div.form-group.mb-3
          label.form-label(for="scan_icon_link") 扫码图标链接
          input#scan_icon_link.form-control(type="text", placeholder="输入扫码图标的链接")
        
        div.d-flex.justify-content-end.mt-4
          button#cancelBtn.btn.btn-secondary.mr-2 取消
          button#submitBtn.btn.btn-primary 提交

    script.
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('labelForm');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // 表单验证
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          if (!form.checkValidity()) {
            e.stopPropagation();
            // 显示错误提示
            const invalidFields = form.querySelectorAll(':invalid');
            invalidFields.forEach(field => {
              field.classList.add('is-invalid');
              field.addEventListener('input', function() {
                if (this.checkValidity()) {
                  this.classList.remove('is-invalid');
                }
              });
            });
            return;
          }

          // 显示加载状态
          submitBtn.disabled = true;
          submitBtn.classList.add('submit-loading');
          submitBtn.innerHTML = '提交中...';

          // 收集表单数据
          const formData = {
            length: parseInt(document.getElementById('length').value),
            width: parseInt(document.getElementById('width').value),
            logo_path: document.getElementById('logo_path').value || null,
            email: document.getElementById('email').value || null,
            website: document.getElementById('website').value || null,
            qr_code_link: document.getElementById('qr_code_link').value || null,
            scan_icon_link: document.getElementById('scan_icon_link').value || null
          };

          // 发送API请求
          axios.post('/api/label', formData)
            .then(function(response) {
              if (response.data.success) {
                showMessage('标签模板添加成功！', 'success');
                // 延迟后重定向到列表页面
                setTimeout(function() {
                  window.location.href = '/label/ls';
                }, 1500);
              } else {
                showMessage(response.data.message || '添加失败，请重试', 'danger');
                resetSubmitButton();
              }
            })
            .catch(function(error) {
              console.error('Error adding label template:', error);
              showMessage('添加失败，请稍后再试', 'danger');
              resetSubmitButton();
            });
        });

        // 取消按钮事件
        cancelBtn.addEventListener('click', function() {
          if (hasFormChanges()) {
            if (confirm('确定要放弃当前输入的内容吗？')) {
              window.location.href = '/label/ls';
            }
          } else {
            window.location.href = '/label/ls';
          }
        });

        // 检查表单是否有更改
        function hasFormChanges() {
          const inputs = form.querySelectorAll('input');
          for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].value.trim() !== '') {
              return true;
            }
          }
          return false;
        }

        // 重置提交按钮状态
        function resetSubmitButton() {
          submitBtn.disabled = false;
          submitBtn.classList.remove('submit-loading');
          submitBtn.innerHTML = '提交';
        }

        // 显示消息
        function showMessage(text, type = 'info') {
          const messageContainer = document.getElementById('messageContainer');
          messageContainer.className = `alert alert-${type}`;
          messageContainer.textContent = text;
          messageContainer.style.display = 'block';

          // 5秒后自动隐藏
          setTimeout(function() {
            messageContainer.style.display = 'none';
          }, 5000);
        }

        // 实时表单验证
        const numberInputs = form.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
          input.addEventListener('input', function() {
            // 只允许输入正整数
            if (this.value < 1) {
              this.value = 1;
            }
            // 移除非数字字符
            this.value = this.value.replace(/[^0-9]/g, '');
          });
        });

        // URL格式验证
        const urlInput = document.getElementById('website');
        urlInput.addEventListener('input', function() {
          // 如果用户输入了内容但没有协议部分，添加 http://
          if (this.value && !this.value.match(/^https?:\/\//)) {
            this.value = 'http://' + this.value;
          }
        });
      });