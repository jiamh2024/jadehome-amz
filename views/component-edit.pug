//- views/component-edit.pug
extends layout

block append head
    title 编辑零部件
    style.
      .form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 8px;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }
      .form-full {
        grid-column: 1 / -1;
      }
      .btn-group {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
      }

block content
    .form-container
      .d-flex.justify-content-between.align-items-center.mb-4
        h3 编辑零部件
        a.btn.btn-outline-secondary(href="/component-ls") 返回列表

      form#componentForm
        input#component_id(type="hidden")
        .form-grid
          //- SKU编码
          .mb-3
            label(for="sku_code" class="form-label") SKU编码 <span class="text-danger">*</span>
            input#sku_code(type="text" class="form-control" required)
            .form-text SKU编码必须唯一

          //- 供应商
          .mb-3
            label(for="supplier" class="form-label") 供应商 <span class="text-danger">*</span>
            input#supplier(type="text" class="form-control" required)

          //- 供应商印象
          .mb-3
            label(for="supplier_impression" class="form-label") 供应商印象
            textarea#supplier_impression(class="form-control" rows="2")
            .form-text 对供应商的评价或印象

          //- 采购价格
          .mb-3
            label(for="purchase_price" class="form-label") 采购价格 <span class="text-danger">*</span>
            input#purchase_price(type="number" step="0.01" class="form-control" required min="0")

          //- 货币单位
          .mb-3
            label(for="currency" class="form-label") 货币单位 <span class="text-danger">*</span>
            select#currency(class="form-select" required)
              option(value="USD") USD ($)
              option(value="CNY") CNY (¥)
              option(value="EUR") EUR (€)
              option(value="GBP") GBP (£)

          //- 重量
          .mb-3
            label(for="weight" class="form-label") 重量 (kg) <span class="text-danger">*</span>
            input#weight(type="number" step="0.01" class="form-control" required min="0")

          //- 库存数量
          .mb-3
            label(for="inventory_quantity" class="form-label") 库存数量 <span class="text-danger">*</span>
            input#inventory_quantity(type="number" class="form-control" required min="0" step="1")

          //- 长度
          .mb-3
            label(for="length" class="form-label") 长度 (cm) <span class="text-danger">*</span>
            input#length(type="number" step="0.01" class="form-control" required min="0")

          //- 宽度
          .mb-3
            label(for="width" class="form-label") 宽度 (cm) <span class="text-danger">*</span>
            input#width(type="number" step="0.01" class="form-control" required min="0")

          //- 高度
          .mb-3
            label(for="height" class="form-label") 高度 (cm) <span class="text-danger">*</span>
            input#height(type="number" step="0.01" class="form-control" required min="0")

          //- 核心规格描述
          .mb-3.form-full
            label(for="core_specs" class="form-label") 核心规格描述 <span class="text-danger">*</span>
            textarea#core_specs(class="form-control" rows="3" required)

          //- 特点及用法
          .mb-3.form-full
            label(for="features_usage" class="form-label") 特点及用法
            textarea#features_usage(class="form-control" rows="4")

          //- 备注
          .mb-3.form-full
            label(for="remarks" class="form-label") 备注
            textarea#remarks(class="form-control" rows="3")

          //- 状态
          .mb-3
            label(for="is_active" class="form-label") 状态
            select#is_active(class="form-select" required)
              option(value="1") 启用
              option(value="0") 停用

        .btn-group.mt-5
          button(type="button" class="btn btn-secondary" onclick="window.location.href='/component-ls'").btn-secondary 取消
          button(type="submit" class="btn btn-primary").btn-primary 更新

    script(src="https://fastly.jsdelivr.net/npm/axios/dist/axios.min.js")
    script.
      //- 页面加载时获取零部件数据
      document.addEventListener('DOMContentLoaded', async () => {
        //- 从URL获取component_id
        const urlParams = new URLSearchParams(window.location.search);
        const componentId = window.location.pathname.split('/').pop();
        
        try {
          const response = await axios.get(`/api/component/${componentId}`);
          const component = response.data.data;
          
          //- 填充表单数据
          document.getElementById('component_id').value = component.component_id;
          document.getElementById('sku_code').value = component.sku_code;
          document.getElementById('supplier').value = component.supplier;
          document.getElementById('supplier_impression').value = component.supplier_impression || '';
          document.getElementById('core_specs').value = component.core_specs;
          document.getElementById('features_usage').value = component.features_usage || '';
          document.getElementById('purchase_price').value = component.purchase_price;
          document.getElementById('currency').value = component.currency;
          document.getElementById('weight').value = component.weight;
          document.getElementById('inventory_quantity').value = component.inventory_quantity;
          document.getElementById('length').value = component.length;
          document.getElementById('width').value = component.width;
          document.getElementById('height').value = component.height;
          document.getElementById('remarks').value = component.remarks || '';
          document.getElementById('is_active').value = component.is_active;
          
        } catch (error) {
          showError('加载零部件数据失败');
          console.error(error);
        }
      });

      //- 表单提交处理
      document.getElementById('componentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const componentId = document.getElementById('component_id').value;
        const formData = {
          sku_code: document.getElementById('sku_code').value,
          supplier: document.getElementById('supplier').value,
          supplier_impression: document.getElementById('supplier_impression').value,
          core_specs: document.getElementById('core_specs').value,
          features_usage: document.getElementById('features_usage').value,
          purchase_price: parseFloat(document.getElementById('purchase_price').value),
          currency: document.getElementById('currency').value,
          weight: parseFloat(document.getElementById('weight').value),
          inventory_quantity: parseInt(document.getElementById('inventory_quantity').value),
          length: parseFloat(document.getElementById('length').value),
          width: parseFloat(document.getElementById('width').value),
          height: parseFloat(document.getElementById('height').value),
          remarks: document.getElementById('remarks').value,
          is_active: parseInt(document.getElementById('is_active').value)
        };

        try {
          const response = await axios.put(`/api/component/${componentId}`, formData);
          showSuccess('零部件更新成功');
          setTimeout(() => {
            window.location.href = '/component-ls';
          }, 1500);
        } catch (error) {
          showError(error.response?.data?.message || '更新失败');
        }
      });

      function showSuccess(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show fixed-top end-0 m-3 z-50';
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
      }

      function showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show fixed-top end-0 m-3 z-50';
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
      }
