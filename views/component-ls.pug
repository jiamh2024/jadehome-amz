//- views/component-ls.pug
extends layout

block append head
    title 零部件管理
    style.
      .table-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 2rem;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 8px;
      }
      .search-box {
        max-width: 400px;
      }
      .specs-preview {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

block content
    .table-container
      .d-flex.justify-content-between.mb-4.align-items-center
        h3 零部件管理
        a.btn.btn-primary(href="/component-add") 
          i.bi.bi-plus-circle
          |  添加新零部件

      .d-flex.justify-content-between.mb-4
        .search-box
          .input-group
            input#searchInput.form-control(
              type="text" 
              placeholder="搜索零部件..."
              onkeyup="searchComponents()"
            )
            button.btn.btn-outline-secondary(type="button")
              i.bi.bi-search

        .d-flex.gap-2
          select#pageLimit.form-select(onchange="loadData()" style="width: 100px")
            option(value="10") 每页10条
            option(value="20") 每页20条
            option(value="50") 每页50条

      table.table.table-hover.table-striped
        thead
          tr
            th(scope="col") SKU编码
            th(scope="col") 供应商
            th(scope="col") 核心规格
            th(scope="col") 采购价格
            th(scope="col") 库存数量
            th(scope="col") 操作
        tbody#dataBody
          tr
            td(colspan="5" class="text-center") 加载数据中...
        
      nav(aria-label="Page navigation")
        ul.pagination.justify-content-center#pagination

    script(src="https://fastly.jsdelivr.net/npm/axios/dist/axios.min.js")
    script.
      let currentPage = 1;
      let currentSearch = '';
      let pageSize = 10;

      // 加载初始数据
      document.addEventListener('DOMContentLoaded', () => {
        loadData();
      });

      async function loadData(page = 1) {
        currentPage = page;
        pageSize = parseInt(document.getElementById('pageLimit').value);
        
        try {
          const response = await axios.get('/api/component', {
            params: {
              page: currentPage,
              limit: pageSize
            }
          });

          renderTable(response.data.data.components);
          renderPagination(response.data.data.pagination);
        } catch (error) {
          showError('加载数据失败');
          console.error(error);
        }
      }

      function renderTable(components) {
        const tbody = document.getElementById('dataBody');
        
        if (components.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-4 text-muted">
                没有找到零部件数据。
              </td>
            </tr>`;
          return;
        }

        tbody.innerHTML = components.map(component => `
          <tr data-id="${component.component_id}">
            <td>
              <strong>${component.sku_code}</strong>
              ${!component.is_active ? '<span class="badge bg-secondary ms-2">已停用</span>' : ''}
            </td>
            <td>
              ${component.supplier}
              ${component.supplier_impression ? `<small class="text-muted d-block">${component.supplier_impression}</small>` : ''}
            </td>
            <td>
              <div class="specs-preview" title="${component.core_specs}">${component.core_specs}</div>
            </td>
            <td>
              ${component.currency} ${component.purchase_price}
            </td>
            <td>
              <span class="badge bg-primary">${component.inventory_quantity}</span>
            </td>
            <td>
              <div class="d-flex gap-2">
                <a href="/component-edit/${component.component_id}" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-pencil-square"></i> 编辑
                </a>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteComponent(${component.component_id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      function renderPagination(pagination) {
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';

        // 上一页按钮
        paginationEl.innerHTML += `
          <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadData(${currentPage - 1})"><i class="bi bi-chevron-left"></i></a>
          </li>`;

        // 页码按钮
        for (let i = 1; i <= pagination.totalPages; i++) {
          paginationEl.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
              <a class="page-link" href="#" onclick="loadData(${i})">${i}</a>
            </li>`;
        }

        // 下一页按钮
        paginationEl.innerHTML += `
          <li class="page-item ${currentPage >= pagination.totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadData(${currentPage + 1})"><i class="bi bi-chevron-right"></i></a>
          </li>`;
      }

      function searchComponents() {
        currentSearch = document.getElementById('searchInput').value;
        loadData(1); // 搜索时重置到第一页
      }

      async function deleteComponent(componentId) {
        if (!confirm('确定要删除这个零部件吗？')) return;

        try {
          await axios.delete(`/api/component/${componentId}`);
          showSuccess('零部件删除成功');
          loadData(currentPage);
        } catch (error) {
          showError(error.response?.data?.message || '删除失败');
        }
      }

      function showSuccess(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
      }

      function showError(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
      }
