//- views/add-competitor.pug
doctype html
html(lang="zh-CN")
  head
    title 新增竞品信息
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    link(href="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet")
    link(href="https://fastly.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet")
    style.
      .form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        border-radius: 8px;
      }
      .form-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
      }
      .required-field::after {
        content: " *";
        color: #dc3545;
      }
      .dimension-inputs {
        display: flex;
        gap: 15px;
      }
      .dimension-inputs .input-group {
        flex: 1;
      }
      .image-preview {
        width: 100%;
        max-width: 200px;
        margin-top: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: none;
      }

  body
    .container.form-container
      .form-header
        h1 
          i.bi.bi-clipboard2-plus
          span.ms-2 新增竞品信息
        p.text-muted 请填写竞品详细信息

      form#competitorForm
        .row.mb-3
          .col-md-6
            label.form-label.required-field(for="product_name") 产品规格名称
            input#product_name.form-control(type="text" name="product_name" required)

          .col-md-6
            label.form-label.required-field(for="brand") 品牌
            input#brand.form-control(type="text" name="brand" required)

        .row.mb-3
          .col-md-6
            label.form-label(for="asin") ASIN
            input#asin.form-control(type="text" name="asin" placeholder="亚马逊产品唯一标识")

        .row.mb-3
          .col-md-6
            label.form-label.required-field(for="country_code") 国家代码
            select#country_code.form-select(name="country_code" required)
              option(value="") -- 选择国家 --
              option(value="US") 美国 (US)
              option(value="UK") 英国 (UK)
              option(value="AE") 阿联酋 (AE)
              option(value="SA") 沙特 (SA)
              option(value="CA") 加拿大 (CA)

          .col-md-6
            label.form-label.required-field(for="sale_price") 销售价格
            .input-group
              span.input-group-text ¥
              input#sale_price.form-control(type="number" name="sale_price" step="0.01" min="0" required)

        .row.mb-3
          .col-md-12
            label.form-label(for="dimensions") 产品尺寸 (cm)
            .dimension-inputs
              .input-group
                span.input-group-text 长
                input#length.form-control(type="number" name="length" step="0.01" min="0")
                span.input-group-text(for="uslt") cm
              .input-group
                span.input-group-text 宽
                input#width.form-control(type="number" name="width" step="0.01" min="0")
                span.input-group-text(for="uslt") cm
              .input-group
                span.input-group-text 高
                input#height.form-control(type="number" name="height" step="0.01" min="0")
                span.input-group-text(for="uslt") cm

        .row.mb-4
          .col-md-6
            label.form-label(for="weight") 产品重量
            .input-group
              input#weight.form-control(type="number" name="weight" step="0.001" min="0")
              span.input-group-text(for="uswt") kg

          .col-md-6
            label.form-label(for="has_battery") 是否带电
            .form-check.mt-2
              input#has_battery.form-check-input(type="checkbox" name="has_battery")
              label.form-check-label(for="has_battery") 是

        // 添加图片上传字段
        .row.mb-3
          .col-md-12
            label.form-label 产品图片上传（最多3张）
            .mb-3
              label.form-label 图片1（主图）
              input#image1.form-control(type="file" name="image1" accept="image/*")
              img#preview1.image-preview(src="" alt="图片预览")
              small.form-text.text-muted 支持JPG、PNG格式，最大5MB
            .mb-3
              label.form-label 图片2
              input#image2.form-control(type="file" name="image2" accept="image/*")
              img#preview2.image-preview(src="" alt="图片预览")
              small.form-text.text-muted 支持JPG、PNG格式，最大5MB
            .mb-3
              label.form-label 图片3
              input#image3.form-control(type="file" name="image3" accept="image/*")
              img#preview3.image-preview(src="" alt="图片预览")
              small.form-text.text-muted 支持JPG、PNG格式，最大5MB

        .d-flex.justify-content-between
          a.btn.btn-secondary(href="/cpls") 
            i.bi.bi-arrow-left
            span.ms-2 返回列表
          button.btn.btn-primary(type="submit")
            i.bi.bi-save
            span.ms-2 保存信息

      #responseToast.toast.position-fixed.top-0.end-0.m-3(style="z-index: 1100")
        .toast-header
          strong#toastTitle.me-auto 通知
          button.btn-close(type="button" data-bs-dismiss="toast")
        .toast-body#toastMessage

    script(src="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js")
    script.
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('competitorForm');
        const toastEl = document.getElementById('responseToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toast = new bootstrap.Toast(toastEl);
        const countryCode = document.getElementById('country_code');
        const unitLabels = document.querySelectorAll('.input-group-text');
        
        // 单位转换函数
        function cmToIn(cm) {
          return (parseFloat(cm) / 2.54).toFixed(2);
        }
        
        function inToCm(inches) {
          return (parseFloat(inches) * 2.54).toFixed(2);
        }
        
        function kgToLb(kg) {
          return (parseFloat(kg) / 0.45359237).toFixed(2);
        }
        
        function lbToKg(lb) {
          return (parseFloat(lb) * 0.45359237).toFixed(3);
        }
        
        // 当国家代码改变时，切换显示单位
        countryCode.addEventListener('change', function() {
          const isUS = this.value === 'US';
          
          // 切换尺寸单位
          if (isUS) {
            document.querySelector('label[for="dimensions"]').textContent = '产品尺寸 (in)';
            document.querySelectorAll('.dimension-inputs .input-group-text')[1].textContent = 'in'; // 长
            document.querySelectorAll('.dimension-inputs .input-group-text')[3].textContent = 'in'; // 宽
            document.querySelectorAll('.dimension-inputs .input-group-text')[5].textContent = 'in'; // 高
            
            // 如果有值，转换为英寸
            if (form.length.value) form.length.value = cmToIn(form.length.value);
            if (form.width.value) form.width.value = cmToIn(form.width.value);
            if (form.height.value) form.height.value = cmToIn(form.height.value);
          } else {
            document.querySelector('label[for="dimensions"]').textContent = '产品尺寸 (cm)';
            document.querySelectorAll('.dimension-inputs .input-group-text')[1].textContent = 'cm'; // 长
            document.querySelectorAll('.dimension-inputs .input-group-text')[3].textContent = 'cm'; // 宽
            document.querySelectorAll('.dimension-inputs .input-group-text')[5].textContent = 'cm'; // 高
            
            // 如果有值，转换为厘米
            if (form.length.value) form.length.value = inToCm(form.length.value);
            if (form.width.value) form.width.value = inToCm(form.width.value);
            if (form.height.value) form.height.value = inToCm(form.height.value);
          }
          
          // 切换重量单位
          if (isUS) {
            document.querySelectorAll('.input-group-text')[7].textContent = 'lb';
            // 如果有值，转换为磅
            if (form.weight.value) form.weight.value = kgToLb(form.weight.value);
          } else {
            document.querySelectorAll('.input-group-text')[7].textContent = 'kg';
            // 如果有值，转换为千克
            if (form.weight.value) form.weight.value = lbToKg(form.weight.value);
          }
        });
        
        // 图片预览功能
        function setupImagePreview(inputId, previewId) {
          const input = document.getElementById(inputId);
          const preview = document.getElementById(previewId);
          
          input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
              const reader = new FileReader();
              
              reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
              }
              
              reader.readAsDataURL(this.files[0]);
            } else {
              preview.src = '';
              preview.style.display = 'none';
            }
          });
        }
        
        // 设置所有图片预览
        setupImagePreview('image1', 'preview1');
        setupImagePreview('image2', 'preview2');
        setupImagePreview('image3', 'preview3');
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // 使用FormData提交表单数据和文件
          const formData = new FormData();
          formData.append('product_name', form.product_name.value);
          formData.append('brand', form.brand.value);
          formData.append('country_code', form.country_code.value);
          formData.append('sale_price', form.sale_price.value);
          
          // 处理单位转换 - 如果是美国，将英寸转换为厘米，磅转换为千克
          if (form.country_code.value === 'US') {
            if (form.length.value) formData.append('length', inToCm(form.length.value));
            if (form.width.value) formData.append('width', inToCm(form.width.value));
            if (form.height.value) formData.append('height', inToCm(form.height.value));
            if (form.weight.value) formData.append('weight', lbToKg(form.weight.value));
          } else {
            if (form.length.value) formData.append('length', form.length.value);
            if (form.width.value) formData.append('width', form.width.value);
            if (form.height.value) formData.append('height', form.height.value);
            if (form.weight.value) formData.append('weight', form.weight.value);
          }
          
          formData.append('has_battery', form.has_battery.checked ? 1 : 0);
          
          // 添加图片文件
          if (form.image1.files.length > 0) {
            formData.append('image1', form.image1.files[0]);
          }
          if (form.image2.files.length > 0) {
            formData.append('image2', form.image2.files[0]);
          }
          if (form.image3.files.length > 0) {
            formData.append('image3', form.image3.files[0]);
          }
          // 添加ASIN字段
          if (form.asin.value) {
            formData.append('asin', form.asin.value);
          }
          
          try {
            const response = await fetch('/api/cp', {
              method: 'POST',
              body: formData
              // 不设置Content-Type，让浏览器自动设置
            });
            
            const result = await response.json();
            
            if (response.ok) {
              showToast('success', '操作成功', '竞品信息已成功添加！');
              form.reset();
              // 重置图片预览
              document.getElementById('preview1').style.display = 'none';
              document.getElementById('preview2').style.display = 'none';
              document.getElementById('preview3').style.display = 'none';
            } else {
              showToast('danger', '操作失败', result.error || '添加竞品信息时出错');
            }
          } catch (error) {
            console.error('Error:', error);
            showToast('danger', '网络错误', '无法连接到服务器，请稍后再试');
          }
        });
        
        function showToast(type, title, message) {
          toastTitle.textContent = title;
          toastMessage.textContent = message;
          toastEl.className = `toast position-fixed top-0 end-0 m-3 show text-bg-${type}`;
          toast.show();
        }
      });